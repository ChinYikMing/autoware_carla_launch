# autoware_carla_launch

The package includes launch file to run Autoware, Carla agent, and bridge (zenoh-bridge-dds + carla_autoware_zenoh_bridge).

# Prerequisites

Make sure you meet the following system requirements

* Ubuntu 20.04
* Autoware.universe galactic version
  - Only needed if you running in native host
* Carla 0.9.13

## Running in native host

* Install Autoware

## Running in docker

```shell
sudo apt install docker.io python3-rocker
./run-docker.sh
```

# Build

* Clean the files

```shell
make clean
```

* Download necessary code & data

```shell
source env.sh
make prepare
```

* Build

```shell
# Source Autoware first before build
make build
```

# Usage

## Carla with Autoware

The section shows how to run Autoware in Carla simulator.

1. Run Carla simulator first

```shell
./CarlaUE4.sh -quality-level=Epic -world-port=2000 -RenderOffScreen
```

2. Run Autoware with Carla
 
```shell
source env.sh
ros2 launch autoware_carla_launch autoware_carla.launch.xml
```

3. (Option) The launch file above equals to the following two commands

```shell
## Running Carla Bridge and Python Agent
ros2 launch autoware_carla_launch carla_bridge.launch.xml
## Running zenoh-bridge-dds and Autoware
ros2 launch autoware_carla_launch autoware_zenoh.launch.xml
```

## Manual control vehicle in Carla

The section shows how to control vehicles manually in Carla.

1. Run Carla simulator first

```shell
./CarlaUE4.sh -quality-level=Epic -world-port=2000 -RenderOffScreen
```

2. Run Autoware with Carla

```shell
source env.sh
ros2 launch autoware_carla_launch manual_control.launch.xml
```

3. Run manual control package

```shell
source env.sh
ros2 run autoware_manual_control keyboard_control
```

# FAQ

* [How to change the map](carla_map/README.md)
* How to run two vehicles in Carla at the same time.
  - Modify `carla_bridge.launch.xml` and add `<executable cmd="poetry run python3 main.py --host $(env CARLA_SIMULATOR_IP) --rolename 'v2'" cwd="$(env AUTOWARE_CARLA_ROOT)/external/carla_autoware_zenoh_bridge/carla_agent" output="screen" />`
  - Run Autoware twice:
    - 1st: `ROS_DOMAIN_ID=1 VEHICLE_NAME="v1" ros2 launch autoware_carla_launch autoware_zenoh.launch.xml`
    - 2nd: `ROS_DOMAIN_ID=2 VEHICLE_NAME="v2" ros2 launch autoware_carla_launch autoware_zenoh.launch.xml`
  - There will be two rviz with separated Autoware at the same time.

# Known Issues

* Upgrade Autoware: Porting the bridge to ROS 2 Humble.
* Generate the map: Now we're using the maps generated by Hatem.
* Running with docker container is really lag...
